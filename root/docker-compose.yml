name: yundera
services:
  admin:
    image: ghcr.io/yundera/settings-center-app:1.1.26
    container_name: admin
    hostname: admin
    restart: unless-stopped
    environment:
      AUTHORITY_ENDPOINT: "https://8080-casaos-${DOMAIN}/v1/users"
      COMPOSE_FOLDER_PATH: "/DATA/AppData/casaos/apps/yundera/"
    volumes:
      # This gives the admin app ssh root access (used to update the system)
      - type: bind
        source: /root/.ssh/
        target: /host_ssh/
      # This gives the admin app access to its own data (used to update itself)
      - type: bind
        source: /DATA/AppData/casaos/apps/yundera/
        target: /app/data
    expose:
      - "80"
    networks:
      pcs: null
    labels:
      caddy: admin-${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
      caddy.import: tls_enabled

  casaos:
    image: ghcr.io/yundera/casa-img:0.4.15-42
    container_name: casaos
    hostname: casaos
    restart: unless-stopped
    environment:
      PUID: 1000 # user ID used by casaos to read and write files
      PGID: 1000 # group ID used by casaos to read and write files
      USER: "${DEFAULT_USER}" # casaos default initial user (optional)
      DATA_ROOT: "/DATA" # where casaos apps data are stored

      # Environment variables used by casaos to configure reverse proxy in the app settings (not used by casaos system)
      REF_DOMAIN: "${DOMAIN}"
      REF_NET: "pcs"
      REF_PORT: "443"
      REF_SCHEME: "https"

      # (deprecated) V1 these envs are not used directly by casaos but are forwarded to the app at creation, injected in the docker compose up
      default_pwd: "${DEFAULT_PWD}"
      public_ip: "${PUBLIC_IPV4}"
      domain: "${DOMAIN}"

      # (deprecated) V2 these envs are not used directly by casaos but are forwarded to the app at creation, injected in the docker compose up
      PCS_DEFAULT_PASSWORD: "${DEFAULT_PWD}"
      PCS_DOMAIN: "${DOMAIN}" # without https://
      PCS_DATA_ROOT: "/DATA"
      PCS_PUBLIC_IP: "${PUBLIC_IPV4}"
      PCS_PUBLIC_IPV6: "${PUBLIC_IPV6}"
      PCS_EMAIL: "admin@${DOMAIN}"

      # V3 these envs are not used directly by casaos but are forwarded to the app at creation, injected in the docker compose up
      APP_DEFAULT_PASSWORD: "${DEFAULT_PWD}"
      APP_DOMAIN: "${DOMAIN}" # without https://
      APP_DATA_ROOT: "/DATA"
      APP_PUBLIC_IP: "${PUBLIC_IPV6}" #can be either v4 or v6 public ip but is regarded as the main IP
      APP_PUBLIC_IPV4: "${PUBLIC_IPV4}"
      APP_PUBLIC_IPV6: "${PUBLIC_IPV6}"
      APP_EMAIL: "admin@${DOMAIN}"
      APP_NET: pcs

      # SMTP configuration for magic link and password reset emails
      SMTP_HOST: "smtp"
      SMTP_PORT: "587"

    networks:
      pcs: null
    labels:
      caddy: 8080-casaos-${DOMAIN}, casaos-${DOMAIN}, ${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8080}}"
      caddy.import: tls_enabled
    volumes:
      - type: bind
        source: /DATA
        target: /DATA
        # Add bind propagation for FUSE mounts
        bind:
          propagation: rshared
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
      - type: bind
        source: /dev
        target: /dev


  # =============================================================================
  # MESH ROUTER TUNNEL (v2)
  # Establishes WireGuard VPN tunnel to the provider for NAT traversal
  # =============================================================================
  mesh-router-tunnel:
    image: ghcr.io/yundera/mesh-router-tunnel:1.2.3
    container_name: mesh-router-tunnel
    hostname: mesh-router-tunnel
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      net.ipv4.ip_forward: "1"
      net.ipv4.conf.all.src_valid_mark: "1"
    environment:
      - PROVIDER=${PROVIDER_STR}
      - ROUTING_TARGET_HOST=mesh-router-caddy
      - ROUTING_TARGET_PORT=80
    networks:
      pcs: null
    depends_on:
      - mesh-router-caddy

  # =============================================================================
  # MESH ROUTER AGENT (v2)
  # Registers public IP with backend for direct routing (bypasses VPN)
  # =============================================================================
  mesh-router-agent:
    image: ghcr.io/yundera/mesh-router-agent:1.0.3
    container_name: mesh-router-agent
    hostname: mesh-router-agent
    restart: unless-stopped
    environment:
      - PROVIDER=${PROVIDER_STR}
      - PUBLIC_IP=${PUBLIC_IPV6}
      - TARGET_PORT=10443
    volumes:
      - /DATA/AppData/yundera/data/certs:/app/data
    networks:
      pcs: null

  # =============================================================================
  # MESH ROUTER CADDY (v2)
  # Reverse proxy with Docker container discovery via labels
  # =============================================================================
  mesh-router-caddy:
    image: lucaslorentz/caddy-docker-proxy:2.9.1-alpine
    container_name: mesh-router-caddy
    hostname: mesh-router-caddy
    restart: unless-stopped
    ports:
      - "10080:80"
      - "10443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /DATA/AppData/casaos/apps/yundera/Caddyfile:/etc/caddy/Caddyfile:ro
      - /DATA/AppData/yundera/data/certs:/certs:ro
      - /DATA/AppData/yundera/data/caddy/data:/data
      - /DATA/AppData/yundera/data/caddy/config:/config
    environment:
      - CADDY_DOCKER_CADDYFILE_PATH=/etc/caddy/Caddyfile
      - CADDY_INGRESS_NETWORKS=pcs
      - PCS_EMAIL=admin@${DOMAIN}
    networks:
      pcs: null
    depends_on:
      - mesh-router-agent

  smtp:
    image: ghcr.io/yundera/yundera-smtp-handler:1.0.2
    container_name: smtp
    hostname: smtp
    restart: unless-stopped
    environment:
      USER_JWT: "${USER_JWT}"
      ORCHESTRATOR_URL: "${YUNDERA_USER_API}"
      SMTP_PORT: "587"
    expose:
      - "587"
    networks:
      pcs: null

networks:
  pcs:
    name: pcs

x-casaos:
  main: admin
  author: Yundera Team
  category: pcs
  hostname: admin-${DOMAIN}
  icon: https://cdn.jsdelivr.net/gh/Yundera/settings-center-app@main/public/YunderaPCS-setting_iconV2.svg
  index: /
  is_uncontrolled: false
  port_map: ""
  scheme: https
  store_app_id: yundera
  title:
    custom: Settings
